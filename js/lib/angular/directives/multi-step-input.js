// Generated by CoffeeScript 1.6.3
(function() {
  'use strict';
  var app;

  app = angular.module('kuew');

  app.directive('multiStepInput', function(templatePath) {
    return {
      restrict: 'EA',
      transclude: true,
      replace: true,
      controller: 'MultiStepInputController',
      templateUrl: templatePath('components/multi-step-input.html'),
      require: '^?ngModel',
      scope: {
        ngModel: '=',
        isValid: '='
      },
      link: function($scope, element, attrs) {
        return $scope.el = function() {
          return element;
        };
      }
    };
  });

  app.controller('MultiStepInputController', function($scope, _, $timeout) {
    var focusElement, indexForModel,
      _this = this;
    $scope.layout = [];
    $scope.maxShown = 1;
    indexForModel = function(model) {
      return _.findIndex($scope.layout, function(l) {
        return l.model === model;
      });
    };
    focusElement = function(i) {
      return $timeout(function() {
        if (!angular.isDefined($scope.el)) {
          return;
        }
        return $scope.el().find('ul li:nth-child(' + i + ') .focusable').focus();
      }, 200);
    };
    $scope.allValid = function() {
      return _.reduceRight($scope.layout, function(a, b) {
        return a && b.model.isValid;
      }, true);
    };
    this.getValues = function() {
      var item, values, _i, _len, _ref;
      values = {};
      _ref = $scope.layout;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        if (item.model.isValid) {
          values[item.name] = item.model.value;
        } else {
          values[item.name] = null;
        }
      }
      return values;
    };
    this.updateList = function() {
      var i;
      i = _.findIndex($scope.layout, function(l) {
        return !l.model.isValid;
      });
      if (i < 0) {
        return $scope.maxShown = $scope.layout.length;
      } else {
        return $scope.maxShown = i + 1;
      }
    };
    this.pushLayout = function(layoutItem) {
      if ($scope.layout.indexOf(layoutItem) === -1) {
        return $scope.layout.push(layoutItem);
      }
    };
    this.showAtLeast = function(model) {
      return this.updateList();
    };
    this.hideUpTo = function(model) {
      var i, j, _i, _ref;
      i = indexForModel(model);
      for (j = _i = i, _ref = $scope.layout.length - 1; i <= _ref ? _i <= _ref : _i >= _ref; j = i <= _ref ? ++_i : --_i) {
        $scope.layout[j].model.reset();
      }
      return this.updateList();
    };
    $scope.$watch('allValid()', function(newValue) {
      return $scope.isValid = !!newValue;
    });
    $scope.$watch('maxShown', function() {
      return focusElement($scope.maxShown - 1);
    });
    return $scope.$watch('layout|field:"model"|field:"value"', function() {
      return $scope.ngModel = _this.getValues();
    }, true);
  });

}).call(this);
